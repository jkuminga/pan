<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전적</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --muted: #94a3b8;
            --text: #e2e8f0;
            --accent: #38bdf8;
            --danger: #f472b6;
            --success: #34d399;
            --border: #1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(120% 120% at 20% 20%, #0b1224, #0f172a 60%, #0b1020);
            color: var(--text);
            font-family: "Pretendard", "Segoe UI", system-ui, -apple-system, sans-serif;
        }
        .page {
            max-width: 1080px;
            margin: 0 auto;
            padding: 24px;
        }
        header.top-bar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        header.top-bar h1 {
            text-align: center;
            margin: 0;
            letter-spacing: 1px;
        }
        .menu-btn{
            justify-self : end; 
            border: 1px solid var(--border);
            background: linear-gradient(135deg, #1e293b, #111827);
            color: var(--text);
            height: 42px;
            border-radius: 20px;
            font-size: 12px;
            padding: 8px 15px;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.1s ease, border-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .menu-btn:hover { transform: translateY(-2px); border-color: var(--accent);  }
        .add-btn {
            border: 1px solid var(--border);
            background: linear-gradient(135deg, #1e293b, #111827);
            color: var(--text);
            border-radius: 20px;
            font-size: 12px;
            padding: 8px 15px;
            margin: 10px;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.1s ease, border-color 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .add-btn:hover { transform: translateY(-2px); border-color: var(--accent);  }
        .search-panel {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 14px;
            border-radius: 14px;
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.35);
            margin-bottom: 18px;
        }
        .search-panel input, .search-panel select, .search-panel button {
            height: 42px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0b1220;
            color: var(--text);
            padding: 0 12px;
            font-size: 14px;
        }
        .search-panel input, .search-panel select { flex: 1; min-width: 0; }
        .search-panel button {
            flex: 0 0 auto;
            background: linear-gradient(135deg, #38bdf8, #22d3ee);
            border: none;
            color: #0b1220;
            font-weight: 700;
            cursor: submit;
            padding: 0 16px;
        }
        .list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 22px;
        }
        .card {
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--muted);
        }
        .pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 0.3px;
        }
        .pill.stake { background: rgba(52, 211, 153, 0.12); color: var(--success); }
        .teams {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 10px;
        }
        .team {
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 10px;
            background: rgba(12, 18, 32, 0.8);
        }
        .team.win-blue {
            border: 1px solid var(--border);
            background: rgba(56, 189, 248, 0.15);
            border-color: rgba(56, 189, 248, 0.4);
        }
        .team.win-red {
            border: 1px solid var(--border);
            background: rgba(244, 114, 182, 0.15);
            border-color: rgba(244, 114, 182, 0.4);
        }
        .team h4 {
            margin: 0 0 8px 0;
            color: var(--muted);
            font-size: 13px;
            letter-spacing: 0.3px;
        }
        .players {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            gap: 6px;
        }
        .player {
            padding: 8px 6px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0b1220;
            text-align: center;
            font-size: 13px;
            color: var(--text);
        }
        .empty {
            padding: 18px;
            text-align: center;
            color: var(--muted);
            border: 1px dashed var(--border);
            border-radius: 12px;
            background: rgba(17, 24, 39, 0.6);
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }
        .stat-card {
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        .stat-card h3 { margin: 0 0 10px 0; letter-spacing: 0.4px; }
        .stat-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .stat-table th, .stat-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        .stat-table th {
            text-align: left;
            color: var(--muted);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .stat-table td { color: var(--text); }
        .stat-table tr:last-child td { border-bottom: none; }
        @media (max-width: 640px) {
            .search-panel { flex-direction: column; }
            header.top-bar { grid-template-columns: auto 1fr auto; }
            .players { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        }
        .pagination {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        /* 삭제 확인 팝업 */
        .confirm-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(17, 24, 39, 0.98);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.45);
            display: none;
            z-index: 5;
        }
        .confirm-popup.active { display: grid; gap: 10px; }
        .confirm-popup .actions { display: flex; gap: 8px; justify-content: flex-end; }
        .confirm-popup button {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: #0b1220;
            color: var(--text);
            cursor: pointer;
        }
        .page-btn{
            background: rgba(17, 24, 39, 0.9);
            border: 1px solid var(--border);
            border-radius: 360px;
            padding: 10px;
            color: white;
            text-decoration: none;
            transition: transform 0.1s ease, border-color 0.2s ease;
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
        }
        .page-btn.current{
            background-color: rgba(43, 45, 110, 0.551);
        }
        .page-btn:hover{
            transform: translateY(-2px); border-color: var(--accent);
        }
    </style>
    <script>
        // 카드 더블클릭/롱프레스 시 삭제 확인 팝업
        document.addEventListener('DOMContentLoaded', () => {
            const cards = Array.from(document.querySelectorAll('.card'));
            cards.forEach((card) => {
                const popup = card.querySelector('.confirm-popup');
                const okBtn = popup?.querySelector('.ok');
                const cancelBtn = popup?.querySelector('.cancel');
                let timer;

                const showPopup = () => popup?.classList.add('active');
                const hidePopup = () => popup?.classList.remove('active');

                const startPress = () => { timer = setTimeout(showPopup, 600); };
                const cancelPress = () => clearTimeout(timer);

                card.addEventListener('dblclick', showPopup);
                card.addEventListener('mousedown', startPress);
                card.addEventListener('touchstart', startPress);

                ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(evt => {
                    card.addEventListener(evt, cancelPress);
                });

                cancelBtn?.addEventListener('click', hidePopup);
                okBtn?.addEventListener('click', async () => {
                    hidePopup();
                    const historyId = card.dataset.historyId;
                    try{
                        const resp = await fetch(`/history/${historyId}`, {
                            method: 'DELETE',
                        });
                        if(!resp.ok) throw new Error('delete failed');
                        // 서버가 { ok: true } 등을 반환한다고 가정하고 새로고침으로 동기화
                        await resp.json().catch(() => ({}));
                        location.reload();
                    }catch(err){
                        console.error(err);
                        alert('삭제 요청에 실패했습니다.');
                    }
                });
            });
        });
    </script>
</head>
<body>
    <div class="page">
        <header class="top-bar">
            <div></div>
            <h1>전적</h1>
            <a href="/history/dates" class="menu-btn">날짜별 전적 보기</a>
        </header>

        <section class="stats">
            <div class="stat-card">
                <h3>Stats</h3>
                <% const rateAndEarningsSafe = rateAndEarnings || []; %>
                <% if (rateAndEarningsSafe.length === 0) { %>
                    <div class="empty" style="border:none;background:none;padding:8px 0;">데이터 없음</div>
                <% } else { %>
                    <table class="stat-table">
                        <thead>
                            <tr>
                                <th>플레이어</th>
                                <th class="text-right">게임 수</th>
                                <th class="text-right">승리</th>
                                <th class="text-right">패배</th>
                                <th class="text-right">승률</th>
                                <th class="text-right">수익</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% rateAndEarningsSafe.forEach((row) => { %>
                                <% const winrate = (row.wins/row.games) * 100 %>
                                <tr>
                                    <td style="font-weight: bold;"><%= row.name || row.player || '-' %></td>
                                    <td class="text-right"><%= row.games !== undefined ? row.games + '판' : '-' %></td>
                                    <td class="text-right"><%= row.wins !== undefined ? row.wins + '승' : '-' %></td>
                                    <td class="text-right"><%= row.losses !== undefined ? row.losses + '패' : '-' %></td>
                                    <td class="text-right"><%= !Number.isNaN(winrate) ? Number(winrate).toFixed(1)  + '%' : '-'  %></td>
                                    <td class="text-right"><%= row.earnings + "원" ?? '-' %></td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                <% } %>
            </div>
        </section>
        <br/>

        <section class="list">
            <div style="display: flex;">
                <h3>History</h1>
                <a href="/history/form" class="add-btn">추가</a>
            </div>
            
            <% const historiesSafe = histories || []; %>
            <% if (historiesSafe.length === 0) { %>
                <div class="empty">전적이 없습니다. 검색 조건을 바꾸거나 새 전적을 추가해 보세요.</div>
            <% } %>

            <% historiesSafe.forEach((h) => { %>
                <% const dateText = (h.created_at || '').split('T')[0] || '-'; %>
                <% const winLabel = (h.win || '').toString().toUpperCase(); %>
                <% const winClass = winLabel === 'BLUE' ? 'win-blue' : 'win-red'; %>
                <% const players = h.players || []; %>
                <% const blueTeam = []; const redTeam = []; %>
                <% players.forEach((p) => { %>
                    <% if (p.side === 'BLUE') { %>
                        <% blueTeam.push(p); %>
                    <% } else { %>
                        <% redTeam.push(p); %>
                    <% } %>
                <% }); %>
                <article class="card" data-history-id="<%= h.id %>">
                    <div class="card-header">
                        <div><%= dateText %> · ID #<%= h.id %></div>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <!-- <span class="pill <%= winClass %>"><%= winLabel || 'N/A' %></span> -->
                            <span class="pill stake"><%= h.stake + '원' ?? '-' %></span>
                        </div>
                    </div>
                    <div class="teams">
                        <div class="team <%= winLabel === 'BLUE' ? 'win-blue' : '' %>">
                            <h4>BLUE</h4>
                            <div class="players">
                                <% blueTeam.forEach((k) => { %>
                                    <span class="player"><%= k['name'] ?? '-' %></span>
                                <% }) %>
                            </div>
                        </div>
                        <div class="team <%= winLabel === 'RED' ? 'win-red' : '' %>">
                            <h4>RED</h4>
                            <div class="players">
                                <% redTeam.forEach((k) => { %>
                                    <span class="player"><%= k['name'] ?? '-' %></span>
                                <% }) %>
                            </div>
                        </div>
                    </div>
                    <div class="confirm-popup">
                        <div style="font-weight:700;">삭제하시겠습니까?</div>
                        <div class="actions">
                            <button type="button" class="cancel">X</button>
                            <button type="button" class="ok">O</button>
                        </div>
                    </div>
                </article>
            <% }) %>
        </section>
        <div class="pagination">
            <% const safePagination = pagination || {}; %>
            <% const pageNo = safePagination.pageNo || 1 %>
            <% const totalPage = safePagination.totalPage || 1 %>
            <% if(pageNo >= 10){ %>
            <button class="page-btn"><</button>
            <% } %>
            <% for(var i = 1; i <= totalPage ; i++){ %>
                <a class="page-btn <%= i === pageNo ? 'current' : ''%>" href="/history/<%= i %>"><%= i %></a>
            <% } %>
            <% if(totalPage >= 10) { %>
            <a href="/history/<%= pageNo +1%>" class="page-btn">></a>
            <% } %>
        </div>
    </div>
</body>
</html>
